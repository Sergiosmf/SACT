#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Interface Streamlit para Sistema CT-e
Camada de Visualiza√ß√£o que integra com a Camada de Aplica√ß√£o
"""

import streamlit as st
import sys
import os
from pathlib import Path
import time
import io
from contextlib import redirect_stdo        # Menu principal
        menu_opcoes = [
            "üîß Processamento CT-e",
            "üìä Opera√ß√£o de Transporte",
            "üí∞ Rentabilidade e Custos",
            "üí¨ Feedback"
        ]irect_stderr

# Configurar paths
current_dir = os.path.dirname(os.path.abspath(__file__))
parent_dir = os.path.dirname(current_dir)
sys.path.insert(0, parent_dir)

# Importar camada de aplica√ß√£o
try:
    from Database.main import CTEMainApplication
    from Config.database_config import validate_config, DATABASE_CONFIG
except ImportError as e:
    st.error(f"‚ùå Erro de importa√ß√£o: {e}")
    st.error(f"Diret√≥rio atual: {current_dir}")
    st.error(f"Diret√≥rio pai: {parent_dir}")
    st.error(f"Caminhos no sys.path: {sys.path[:5]}")
    st.stop()


class StreamlitCTEInterface:
    """Interface Streamlit para o Sistema CT-e"""
    
    def __init__(self):
        """Inicializa a interface Streamlit"""
        self.app = CTEMainApplication()
        
    def setup_page(self):
        """Configura a p√°gina principal do Streamlit"""
        st.set_page_config(
            page_title="Sistema CT-e",
            page_icon="üöõ",
            layout="wide",
            initial_sidebar_state="expanded"
        )
        
        # Header principal
        st.title("üöõ Sistema de Processamento CT-e")
        st.markdown("**Alimenta√ß√£o Autom√°tica do Banco de Dados PostgreSQL**")
        st.divider()
        
    def mostrar_status_configuracao(self):
        """Mostra o status da configura√ß√£o do sistema"""
        st.subheader("üìã 1. Status da Configura√ß√£o")
        
        with st.container():
            config_validation = validate_config()
            
            if config_validation['valid']:
                st.success("‚úÖ Configura√ß√£o v√°lida")
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.info(f"üèõÔ∏è **Banco:** {DATABASE_CONFIG['database']}")
                with col2:
                    st.info(f"üè† **Host:** {DATABASE_CONFIG['host']}:{DATABASE_CONFIG['port']}")
                with col3:
                    st.info(f"üë§ **Usu√°rio:** {DATABASE_CONFIG['user']}")
                
                return True
            else:
                st.error("‚ùå Configura√ß√£o inv√°lida")
                for erro in config_validation['errors']:
                    st.error(f"‚Ä¢ {erro}")
                return False
    
    def selecionar_diretorio(self):
        """Interface para sele√ß√£o de diret√≥rio"""
        st.subheader("üìã 2. Sele√ß√£o de Diret√≥rio")
        
        # Abordagem alternativa: mostrar instru√ß√µes e usar drag&drop simulado
        col1, col2 = st.columns([3, 1])
        
        with col1:
            # Input para caminho do diret√≥rio
            diretorio_path = st.text_input(
                "Caminho do diret√≥rio com arquivos XML:",
                placeholder="/caminho/para/arquivos/xml",
                help="Digite o caminho completo para o diret√≥rio contendo os arquivos CT-e XML",
                key="diretorio_input"
            )
        
        with col2:
            st.write("")  # Espa√ßo para alinhar com o input
            if st.button("ÔøΩ Dica", help="Como encontrar o caminho"):
                st.info("""
                **Como encontrar o caminho do diret√≥rio:**
                
                **No macOS:**
                1. Abra o Finder
                2. Navegue at√© a pasta desejada
                3. Clique com bot√£o direito ‚Üí "Copiar caminho"
                4. Cole aqui no campo acima
                
                **Exemplo:** `/Users/seu_usuario/Documents/CT-e/mes_10_2025`
                """)
        
        # Alternativa: file uploader para arquivos √∫nicos (como demonstra√ß√£o)
        st.write("**Alternativa:** Para teste, voc√™ pode fazer upload de alguns arquivos XML:")
        uploaded_files = st.file_uploader(
            "Selecione arquivos XML de CT-e",
            accept_multiple_files=True,
            type=['xml'],
            help="Selecione um ou mais arquivos XML para teste"
        )
        
        # Processar diret√≥rio digitado
        if diretorio_path:
            diretorio = Path(diretorio_path)
            
            if diretorio.exists() and diretorio.is_dir():
                # Usar FileManager para descobrir arquivos XML
                xml_files = self.app.file_manager.descobrir_arquivos_xml(diretorio)
                total_arquivos = len(xml_files)
                
                if total_arquivos > 0:
                    st.success(f"‚úÖ Diret√≥rio v√°lido: {diretorio.name}")
                    st.info(f"üìä Total de arquivos XML encontrados: {total_arquivos}")
                    
                    # Mostrar alguns exemplos de arquivos
                    if total_arquivos > 0:
                        st.write("**Exemplos de arquivos encontrados:**")
                        for arquivo in xml_files[:5]:  # Mostrar apenas os primeiros 5
                            st.write(f"‚Ä¢ {arquivo.name}")
                        
                        if total_arquivos > 5:
                            st.write(f"... e mais {total_arquivos - 5} arquivos")
                    
                    return diretorio, total_arquivos
                else:
                    st.warning("‚ö†Ô∏è Nenhum arquivo XML encontrado no diret√≥rio")
                    return None, 0
            else:
                if diretorio_path:  # S√≥ mostrar erro se o usu√°rio digitou algo
                    st.error("‚ùå Diret√≥rio n√£o existe ou n√£o √© v√°lido")
                return None, 0
        
        # Processar arquivos enviados como alternativa
        if uploaded_files:
            st.success(f"‚úÖ {len(uploaded_files)} arquivo(s) selecionado(s) para teste")
            st.info("üìù **Nota:** Esta √© uma funcionalidade de teste. Para processamento completo, use um diret√≥rio.")
            
            # Criar diret√≥rio tempor√°rio e salvar arquivos
            import tempfile
            temp_dir = Path(tempfile.mkdtemp())
            
            for uploaded_file in uploaded_files:
                file_path = temp_dir / uploaded_file.name
                with open(file_path, 'wb') as f:
                    f.write(uploaded_file.getbuffer())
            
            return temp_dir, len(uploaded_files)
        
        return None, 0
    
    def configurar_parametros(self):
        """Interface para configura√ß√£o de par√¢metros"""
        st.subheader("üìã 3. Configura√ß√£o de Par√¢metros")
        
        # Configura√ß√£o do custo por quil√¥metro
        custo_por_km = st.number_input(
            "Custo por Quil√¥metro (R$):",
            min_value=0.01,
            value=2.50,
            step=0.01,
            format="%.2f",
            help="Valor em reais por quil√¥metro para c√°lculos de rendimento"
        )
        
        st.info(f"üí∞ Custo configurado: R$ {custo_por_km:.2f} por km")
        
        return custo_por_km
    
    def processar_arquivos_interface(self, diretorio: Path, custo_por_km: float):
        """Interface para processamento de arquivos"""
        st.subheader("üìã 4. Processamento de Arquivos")
        
        # Bot√£o para iniciar processamento
        if st.button("üöÄ Iniciar Processamento", type="primary", use_container_width=True):
            return self.executar_processamento(diretorio, custo_por_km)
        
        return False
    
    def executar_processamento(self, diretorio: Path, custo_por_km: float):
        """Executa o processamento dos arquivos com feedback em tempo real"""
        
        # Containers para feedback
        status_container = st.container()
        progress_container = st.container()
        log_container = st.container()
        
        with status_container:
            st.info("üîÑ Iniciando processamento...")
        
        with progress_container:
            progress_bar = st.progress(0)
            status_text = st.empty()
        
        with log_container:
            log_placeholder = st.empty()
        
        try:
            # Capturar sa√≠da do processamento
            output_buffer = io.StringIO()
            
            # Inicializar sistema
            with redirect_stdout(output_buffer), redirect_stderr(output_buffer):
                inicializado = self.app.inicializar_sistema()
            
            logs = output_buffer.getvalue()
            log_placeholder.text_area("üìù Logs do Sistema:", value=logs, height=200)
            
            if not inicializado:
                status_container.error("‚ùå Falha na inicializa√ß√£o do sistema")
                return False
            
            progress_bar.progress(20)
            status_text.text("‚úÖ Sistema inicializado - Processando arquivos...")
            
            # Processar arquivos
            output_buffer = io.StringIO()
            inicio_tempo = time.time()
            
            with redirect_stdout(output_buffer), redirect_stderr(output_buffer):
                sucesso = self.app.processar_arquivos(diretorio, custo_por_km)
            
            logs_processamento = output_buffer.getvalue()
            log_placeholder.text_area("üìù Logs do Sistema:", value=logs + "\n" + logs_processamento, height=300)
            
            tempo_total = time.time() - inicio_tempo
            
            progress_bar.progress(100)
            
            if sucesso:
                status_container.success("üéâ Processamento conclu√≠do com sucesso!")
                status_text.text(f"‚úÖ Conclu√≠do em {tempo_total:.1f} segundos")
                
                # Mostrar resumo
                st.subheader("üìä Resumo Final")
                st.metric("‚è±Ô∏è Tempo Total", f"{tempo_total:.1f}s")
                
                return True
            else:
                status_container.error("‚ùå Falha no processamento")
                status_text.text("‚ùå Processo falhou - verifique os logs")
                return False
                
        except Exception as e:
            status_container.error(f"‚ùå Erro inesperado: {e}")
            return False
    
    def mostrar_footer(self):
        """Mostra rodap√© da aplica√ß√£o"""
        st.divider()
        st.markdown("---")
        st.markdown(
            """
            <div style='text-align: center; color: #666;'>
                üöõ Sistema de Processamento CT-e | 
                Camada de Visualiza√ß√£o Streamlit integrada √† Camada de Aplica√ß√£o
            </div>
            """, 
            unsafe_allow_html=True
        )
    
    def run(self):
        """Executa a interface principal"""
        # Setup da p√°gina
        self.setup_page()
        
        # Menu principal
        menu_opcoes = [
            "üîß Processamento CT-e",
            "üìä Opera√ß√£o de Transporte",
            "ÔøΩ Rentabilidade e Custos",
            "ÔøΩüí¨ Feedback"
        ]
        
        menu_selecionado = st.selectbox(
            "üìã Selecione uma funcionalidade:",
            menu_opcoes,
            index=0
        )
        
        st.divider()
        
        # Executa a funcionalidade selecionada
        if menu_selecionado == "üîß Processamento CT-e":
            self.pagina_processamento()
        elif menu_selecionado == "üìä Opera√ß√£o de Transporte":
            self.pagina_operacao_transporte()
        elif menu_selecionado == "üí∞ Rentabilidade e Custos":
            self.pagina_rentabilidade_custos()
        else:  # Feedback
            self.pagina_feedback()
        
        # Footer
        self.mostrar_footer()
    
    def pagina_processamento(self):
        """P√°gina de processamento CT-e (funcionalidade original)"""
        # 1. Status da configura√ß√£o
        config_valida = self.mostrar_status_configuracao()
        
        if not config_valida:
            st.stop()
        
        st.divider()
        
        # 2. Sele√ß√£o de diret√≥rio
        diretorio, total_arquivos = self.selecionar_diretorio()
        
        if diretorio and total_arquivos > 0:
            st.divider()
            
            # 3. Configura√ß√£o de par√¢metros
            custo_por_km = self.configurar_parametros()
            
            st.divider()
            
            # 4. Processamento
            self.processar_arquivos_interface(diretorio, custo_por_km)
    
    def pagina_operacao_transporte(self):
        """P√°gina de visualiza√ß√£o de Opera√ß√£o de Transporte"""
        try:
            # Importar componente de opera√ß√£o de transporte
            sys.path.append(os.path.join(current_dir, 'components'))
            from components.operacao_transporte import exibir_operacao_transporte
            
            # Exibir visualiza√ß√µes
            exibir_operacao_transporte()
            
        except ImportError as e:
            st.error(f"‚ùå Erro ao carregar componente: {e}")
            st.error("Verifique se o arquivo components/operacao_transporte.py existe")
        except Exception as e:
            st.error(f"‚ùå Erro ao exibir visualiza√ß√µes: {e}")
            import traceback
            st.code(traceback.format_exc())
    
    def pagina_rentabilidade_custos(self):
        """P√°gina de visualiza√ß√£o de Rentabilidade e Custos"""
        try:
            # Importar componente de rentabilidade e custos
            sys.path.append(os.path.join(current_dir, 'components'))
            from components.rentabilidade_custos import exibir_rentabilidade_custos
            
            # Exibir visualiza√ß√µes
            exibir_rentabilidade_custos()
            
        except ImportError as e:
            st.error(f"‚ùå Erro ao carregar componente: {e}")
            st.error("Verifique se o arquivo components/rentabilidade_custos.py existe")
        except Exception as e:
            st.error(f"‚ùå Erro ao exibir visualiza√ß√µes: {e}")
            import traceback
            st.code(traceback.format_exc())
    
    def pagina_feedback(self):
        """P√°gina de feedback do usu√°rio"""
        try:
            # Importar componente de feedback
            sys.path.append(os.path.join(current_dir, 'components'))
            from components.feedback import create_feedback_form, display_feedback_stats
            
            # Criar formul√°rio de feedback
            manager = create_feedback_form()
            
            # Mostrar estat√≠sticas
            display_feedback_stats(manager)
            
            # Informa√ß√µes adicionais
            st.divider()
            st.info("""
            üí° **Onde seus feedbacks s√£o salvos?**
            
            Todos os feedbacks s√£o salvos em arquivos `.txt` no diret√≥rio `Streamlit/feedback/`.
            Cada feedback gera um arquivo √∫nico com timestamp para f√°cil rastreamento.
            
            Os arquivos podem ser facilmente acessados, lidos e organizados pela equipe de desenvolvimento.
            """)
            
        except ImportError as e:
            st.error(f"‚ùå Erro ao carregar componente de feedback: {e}")
            st.error("Verifique se o arquivo components/feedback.py existe")
        except Exception as e:
            st.error(f"‚ùå Erro ao exibir feedback: {e}")
            import traceback
            st.code(traceback.format_exc())


def main():
    """Entry point da aplica√ß√£o Streamlit"""
    interface = StreamlitCTEInterface()
    interface.run()


if __name__ == "__main__":
    main()